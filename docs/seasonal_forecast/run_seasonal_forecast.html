<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Running the seasonal forecast &mdash; BCPU-documentation 0.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=2709fde1"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Processing seasonal forecast" href="process_seasonal_forecast.html" />
    <link rel="prev" title="About the seasonal forecast" href="about_seasonal_forecast.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            BCPU-documentation
          </a>
              <div class="version">
                0.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Content:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="seasonal_forecast.html">Seasonal forecast</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="about_seasonal_forecast.html">About the seasonal forecast</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Running the seasonal forecast</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#update-the-data-for-assimilation">Update the data for assimilation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-the-analysis">Run the analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-the-prediction">Run the prediction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#clearing-up">Clearing up</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="process_seasonal_forecast.html">Processing seasonal forecast</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../support/support.html">Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute/contribute.html">Contribute</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links:</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://bjerknescpu.github.io/BCPU-data-structure/index.html">Storage</a></li>
<li class="toctree-l1"><a class="reference external" href="https://wiki.uib.no/norcpm/index.php/Norwegian_Climate_Prediction_Model">NorCPM</a></li>
<li class="toctree-l1"><a class="reference external" href="https://bjerknescpu.github.io/BCPU-documentation/planned_experiments.pdf">Planned experiments</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">BCPU-documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="seasonal_forecast.html">Seasonal forecast</a></li>
      <li class="breadcrumb-item active">Running the seasonal forecast</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/seasonal_forecast/run_seasonal_forecast.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="running-the-seasonal-forecast">
<h1>Running the seasonal forecast<a class="headerlink" href="#running-the-seasonal-forecast" title="Link to this heading"></a></h1>
<p>This page provides documentation on how to run the NorCPM seasonal forecast. In general there are four steps to this process:</p>
<ol class="arabic simple">
<li><p>Update the observational data.</p></li>
<li><p>Run forward the analysis to present day, using new observational data.</p></li>
<li><p>Run the prediction/forecast.</p></li>
<li><p>Clear up, and post-processing (see next page).</p></li>
</ol>
<p>The forecast should always be provided on the evening of the 14th of the month, as our collaborators need it on the 15th.</p>
<p>The Met Office provides monthly updates to EN4.2.2. observational temperature and salinity profiles, and these updates happen on the 9th-17th of each month. If this update can be included into the assimilation then this is good, as it gives us an additional month of temperature and salinity data to assimilate. You can check when the last update was on the Met Office <a class="reference external" href="https://www.metoffice.gov.uk/hadobs/en4/download-en4-2-2.html">site</a> (see bottom of page, or look at file links). I would recommend running the analysis on the 12th/13th of the month. It takes ~3 hours to run. I would then recommend running the prediction on the 12/13th, this takes ~2 hours. The post processing takes another ~2 hours. Therefore, if there are no issues the whole workflow takes around 1 working day, but doing this on the 12/13th allows for potential issues (e.g. machine instability) to be addressed. It is important to keep an eye out for Betzy downtime announcements in the week preceding the 15th to ensure there is no significant disruption.</p>
<section id="update-the-data-for-assimilation">
<h2>Update the data for assimilation<a class="headerlink" href="#update-the-data-for-assimilation" title="Link to this heading"></a></h2>
<p>The first step in running the seasonal forecast is to update the observational data that is assimilated into the analysis.</p>
<p>Update the temperature and salinity profile data.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">cluster</span><span class="o">/</span><span class="n">shared</span><span class="o">/</span><span class="n">noresm</span><span class="o">/</span><span class="n">norcpm</span><span class="o">/</span><span class="n">Obs</span><span class="o">/</span><span class="n">TEM</span><span class="o">/</span><span class="n">EN422</span><span class="o">/</span>
<span class="o">./</span><span class="n">Update_profile</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>Now the SST, temperature and salinity profiles are updated.</p>
<p>When it comes to running the analysis, it is important to note that some of the temperature and salinity profiles are initially uploaded by the Met Office as ‘preliminary’, and then are replaced later by ‘final’ files. We always want to run the analysis with the best possible data, which means that each month, we will re-run the part of the analysis that used ‘preliminary’ data last month. This means that it is important to keep track of what the latest observational files are each month.</p>
<p>A log file of each SST, temperature and salinity retrieval has automatically be generated by the download scripts. This includes a file listing, so that the most recently downloaded final and preliminary files can be seen.</p>
<p>For example the file listing might include the files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">EN</span><span class="mf">.4.2.2</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">g10</span><span class="mf">.202207</span><span class="o">.</span><span class="n">nc</span>
<span class="n">EN</span><span class="mf">.4.2.2</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">g10</span><span class="mf">.202208</span><span class="o">.</span><span class="n">nc</span>
</pre></div>
</div>
<p>This means that we have preliminary profiles for 2022/08 and final profiles for 2022/07. Next month when we run the analysis, we will run it from 2022/07.</p>
</section>
<section id="run-the-analysis">
<h2>Run the analysis<a class="headerlink" href="#run-the-analysis" title="Link to this heading"></a></h2>
<p>Move into the analysis directory. The settings file for this seasonal forecast is then in settings/default_settings_VCF.sh</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">cluster</span><span class="o">/</span><span class="n">projects</span><span class="o">/</span><span class="n">nn9039k</span><span class="o">/</span><span class="n">people</span><span class="o">/</span><span class="n">tbi045</span><span class="o">/</span><span class="n">NorCPM</span><span class="o">/</span><span class="n">analysis</span><span class="o">/</span>
<span class="n">ls</span> <span class="n">settings</span><span class="o">/</span><span class="n">default_settings_VCF</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>Check which date should be the start date for the analysis run this month. This is the date of which the last ‘final’ EN.4.2.2. file was for last month’s run.</p>
<p>Check if the correct restart files for your start date exist in your run directory (usually these will be automatically deleted).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ls</span> <span class="o">/</span><span class="n">cluster</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">tbi045</span><span class="o">/</span><span class="n">noresm</span><span class="o">/</span><span class="n">norcpm</span><span class="o">-</span><span class="n">cf</span><span class="o">-</span><span class="n">system1_assim_19811115</span><span class="o">/</span><span class="n">norcpm</span><span class="o">-</span><span class="n">cf</span><span class="o">-</span><span class="n">system1_assim_19811115_mem01</span><span class="o">/</span><span class="n">run</span><span class="o">/</span>
</pre></div>
</div>
<p>If they do not exist, then you need to copy them over by providing the start date as an argument in the form YYYY-MM-DD.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">script_pot</span><span class="o">/</span>
<span class="o">./</span><span class="n">mv_rst_from_archive_to_run</span><span class="o">.</span><span class="n">sh</span> <span class="n">YYYY</span><span class="o">-</span><span class="n">MM</span><span class="o">-</span><span class="n">DD</span>
</pre></div>
</div>
<p>To run the analysis, make sure that you load the correct environments, and make sure you provide a start date argument to sbatch in the form YYYY-MM-DD</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="o">/</span><span class="n">cluster</span><span class="o">/</span><span class="n">projects</span><span class="o">/</span><span class="n">nn9039k</span><span class="o">/</span><span class="n">people</span><span class="o">/</span><span class="n">tbi045</span><span class="o">/</span><span class="n">NorCPM</span><span class="o">/</span><span class="n">analysis</span><span class="o">/</span><span class="n">load_envs</span><span class="o">.</span><span class="n">sh</span>
<span class="n">sbatch</span> <span class="n">submit_reanalysis_VCF</span><span class="o">.</span><span class="n">sh</span> <span class="n">YYYY</span><span class="o">-</span><span class="n">MM</span><span class="o">-</span><span class="n">DD</span>
</pre></div>
</div>
<p>Check that the analysis ran to the expected month (it will crash when there is no more data to assimilate for a month).</p>
</section>
<section id="run-the-prediction">
<h2>Run the prediction<a class="headerlink" href="#run-the-prediction" title="Link to this heading"></a></h2>
<p>Now that the analysis is updated, we can run the prediction.</p>
<p>Move into prediction directory.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">cluster</span><span class="o">/</span><span class="n">projects</span><span class="o">/</span><span class="n">nn9039k</span><span class="o">/</span><span class="n">people</span><span class="o">/</span><span class="n">tbi045</span><span class="o">/</span><span class="n">NorCPM</span><span class="o">/</span><span class="n">prediction</span><span class="o">/</span><span class="n">use_cases</span><span class="o">/</span>
</pre></div>
</div>
<p>Create a new use_case file. The date in the filename should be changed to the date of last data assimilated. The date inside the file needs to be changed in two places</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="n">norcpm</span><span class="o">-</span><span class="n">cf</span><span class="o">-</span><span class="n">system1_hindcast1_20221015</span><span class="o">.</span><span class="ow">in</span> <span class="n">norcpm</span><span class="o">-</span><span class="n">cf</span><span class="o">-</span><span class="n">system1_hindcast1_</span><span class="o">&lt;</span><span class="n">date</span><span class="o">&gt;.</span><span class="ow">in</span>
<span class="n">vi</span> <span class="n">norcpm</span><span class="o">-</span><span class="n">cf</span><span class="o">-</span><span class="n">system1_hindcast1_</span><span class="o">&lt;</span><span class="n">date</span><span class="o">&gt;.</span><span class="ow">in</span>
</pre></div>
</div>
<p>Obtain restart files using your new use_case file</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">cluster</span><span class="o">/</span><span class="n">projects</span><span class="o">/</span><span class="n">nn9039k</span><span class="o">/</span><span class="n">people</span><span class="o">/</span><span class="n">tbi045</span><span class="o">/</span><span class="n">NorCPM</span><span class="o">/</span><span class="n">prediction</span><span class="o">/</span>
<span class="o">./</span><span class="n">obtain_restarts</span><span class="o">.</span><span class="n">sh</span> <span class="n">use_cases</span><span class="o">/</span><span class="n">norcpm</span><span class="o">-</span><span class="n">cf</span><span class="o">-</span><span class="n">system1_hindcast1_</span><span class="o">&lt;</span><span class="n">date</span><span class="o">&gt;.</span><span class="ow">in</span>
</pre></div>
</div>
<p>Create a template, create an ensemble, and submit the prediction.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">create_template</span><span class="o">.</span><span class="n">sh</span> <span class="n">use_cases</span><span class="o">/</span><span class="n">norcpm</span><span class="o">-</span><span class="n">cf</span><span class="o">-</span><span class="n">system1_hindcast1_</span><span class="o">&lt;</span><span class="n">date</span><span class="o">&gt;.</span><span class="ow">in</span>
<span class="o">./</span><span class="n">create_ensemble</span><span class="o">.</span><span class="n">sh</span> <span class="n">use_cases</span><span class="o">/</span><span class="n">norcpm</span><span class="o">-</span><span class="n">cf</span><span class="o">-</span><span class="n">system1_hindcast1_</span><span class="o">&lt;</span><span class="n">date</span><span class="o">&gt;.</span><span class="ow">in</span>
<span class="o">./</span><span class="n">submit_ensemble</span><span class="o">.</span><span class="n">sh</span> <span class="n">use_cases</span><span class="o">/</span><span class="n">norcpm</span><span class="o">-</span><span class="n">cf</span><span class="o">-</span><span class="n">system1_hindcast1_</span><span class="o">&lt;</span><span class="n">date</span><span class="o">&gt;.</span><span class="ow">in</span>
</pre></div>
</div>
<p>Check that the prediction ran to the expected month, and was archived correctly e.g. check files have been moved to archive.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ls /cluster/work/users/${USER}/archive/norcpm-cf-system1_hindcast1_20221115/norcpm-cf-system1_hindcast1_20221115_mem01/atm/hist/
</pre></div>
</div>
</section>
<section id="clearing-up">
<h2>Clearing up<a class="headerlink" href="#clearing-up" title="Link to this heading"></a></h2>
<p>Run mergediag.sh (modify the directory name in the file).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">cluster</span><span class="o">/</span><span class="n">projects</span><span class="o">/</span><span class="n">nn9039k</span><span class="o">/</span><span class="n">people</span><span class="o">/</span><span class="n">tbi045</span><span class="o">/</span><span class="n">NorCPM</span><span class="o">/</span><span class="n">tools</span>
<span class="n">vi</span> <span class="n">mergediag</span><span class="o">.</span><span class="n">sh</span>
<span class="n">sbatch</span> <span class="n">mergediag</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>This produces a merged directory in the archive (takes some time) e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/cluster/work/users/${USER}/archive/norcpm-cf-system1_hindcast1_20220915/norcpm-cf-system1_hindcast1_20220915_mem01-60
</pre></div>
</div>
<p>Copy forecast files to NIRD, using scp or rsync from above directory. e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cd /cluster/work/users/${USER}/archive/norcpm-cf-system1_hindcast1_20220915/
scp -r norcpm-cf-system1_hindcast1_20220915_mem01-60/ $USER@login1-trd.nird.sigma2.no:/projects/NS9039K/shared/ClimateFutures/new/
</pre></div>
</div>
<p>Delete restart files that will not be needed anymore. You need to determine which restart files you will need next month.
The analysis next month should start from the last ‘final’ assimilation files that were used, so in this example, if temperature and salinity profiles were noted down as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">EN</span><span class="mf">.4.2.2</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">g10</span><span class="mf">.202207</span><span class="o">.</span><span class="n">nc</span>
<span class="n">EN</span><span class="mf">.4.2.2</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">g10</span><span class="mf">.202208</span><span class="o">.</span><span class="n">nc</span>
</pre></div>
</div>
<p>Then the analysis will continue from 202207, so keep these restart files, with care, remove any others e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cd /cluster/work/users/${USER}/archive/norcpm-cf-system1_assim_19811115/
rm -rf norcpm-cf-system1_assim_19811115_mem??/rest/2022-04-15-00000/
</pre></div>
</div>
<p>Compress files.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">cluster</span><span class="o">/</span><span class="n">projects</span><span class="o">/</span><span class="n">nn9039k</span><span class="o">/</span><span class="n">people</span><span class="o">/</span><span class="n">tbi045</span><span class="o">/</span><span class="n">NorCPM</span><span class="o">/</span><span class="n">tools</span>
<span class="n">sbatch</span> <span class="n">fanf_noresm2netcdf4</span><span class="o">.</span><span class="n">pbs</span>
</pre></div>
</div>
<p>Move analysis files to NIRD, on NIRD:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">projects</span><span class="o">/</span><span class="n">NS9039K</span><span class="o">/</span><span class="n">shared</span><span class="o">/</span><span class="n">tbi045</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span>
<span class="o">./</span><span class="n">Transfer_reana</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>Check the files on NIRD, and this concludes generation of the forecast. For steps on processing the output, please see the separate documentation page.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="about_seasonal_forecast.html" class="btn btn-neutral float-left" title="About the seasonal forecast" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="process_seasonal_forecast.html" class="btn btn-neutral float-right" title="Processing seasonal forecast" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, BCPU.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>